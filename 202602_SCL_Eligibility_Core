CREATE OR REPLACE TEMPORARY TABLE SCL_2025 AS

-- STEP 1: Deduplicate using Window Functions
WITH Unique_SCL_Sales AS (
    SELECT 
        uai_id,
        score_branch_no,
        SALE_CT,
        CANCEL_CT
    FROM 
        core.optional_product_sale
    WHERE 
        coverage_abbreviation_cd = 'SCL'
        AND LOAN_ELIGIBLE = 'Y'
    
    -- "QUALIFY" filters the results of the window function directly
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY uai_id, score_branch_no
        ORDER BY 
            -- PRIORITY 1: Grab the row that shows a Sale (Don't pick the 0s!)
            SALE_CT DESC, 
            -- PRIORITY 2: Grab the row that shows a Cancel
            CANCEL_CT DESC,
            -- PRIORITY 3: If still tied, take the latest update
            RECORD_UPDATE_TS DESC
    ) = 1
)

-- STEP 2: Join 1-to-1 to Production (Same as before)
SELECT 
    A.*, 
    
    CASE 
        WHEN ops.uai_id IS NULL THEN '1. Not Eligible'
        ELSE 
            CASE 
                WHEN COALESCE(ops.SALE_CT, 0) = 0 THEN '2. Eligible - Waived'
                WHEN ops.SALE_CT > 0 THEN
                    CASE 
                        WHEN COALESCE(ops.CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
                        ELSE '3. Sold - Active'
                    END
            END
    END AS SCL_LIFECYCLE_STATUS,

    -- STRATEGIC FLAGS
    CASE WHEN ops.uai_id IS NOT NULL THEN 1 ELSE 0 END AS IS_SCL_ELIGIBLE,
    CASE WHEN ops.uai_id IS NOT NULL AND ops.SALE_CT > 0 THEN 1 ELSE 0 END AS IS_SCL_GROSS_SOLD,
    CASE WHEN ops.uai_id IS NOT NULL AND ops.SALE_CT > 0 AND COALESCE(ops.CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_SCL_NET_SOLD,
    CASE WHEN ops.uai_id IS NOT NULL AND ops.SALE_CT > 0 AND COALESCE(ops.CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCL_CANCELED

FROM 
    bdm.app_loan_production A
LEFT JOIN 
    Unique_SCL_Sales ops
    ON A.uai_id = ops.uai_id
    AND CAST(A.own_score_brnch AS INT) = CAST(ops.score_branch_no AS INT)

WHERE 
    A.CORE_V_CAPP = 'Core'
    AND A.APPL_STAT = 'BOOK'
    AND A.APPROVED_FLAG = 'Y'
    AND A.contr_date BETWEEN '2025-01-01' AND '2025-12-31';
