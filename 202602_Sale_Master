-- ====================================================================
-- PHASE 1: CREATE CLEAN VIEWS (DEDUPLICATED)
-- ====================================================================

-- SCL (Single Credit Life)
CREATE OR REPLACE TEMP VIEW view_SCL_flags AS
WITH Unique_SCL AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'SCL' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_SCL_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_SCL_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_SCL_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCL_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCL_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCL_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_SCL_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS SCL_LIFECYCLE_STATUS,
    COVERAGE_ID AS SCL_COVERAGE_ID,
    POLICY_ID AS SCL_POLICY_ID,
    SALES_TYPE AS SCL_SALES_TYPE,
    BIF_BRANCH_NO AS SCL_BIF_BRANCH_NO,
    CERTIFICATE_NO AS SCL_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS SCL_SALE_MONTH_END_DT,
    SALE_CT AS SCL_SALE_CT,
    CANCEL_MONTH_END_DT AS SCL_CANCEL_MONTH_END_DT,
    CANCEL_CT AS SCL_CANCEL_CT,
    CANCEL_30DAY_CT AS SCL_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS SCL_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS SCL_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS SCL_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS SCL_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS SCL_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS SCL_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS SCL_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS SCL_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS SCL_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS SCL_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS SCL_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS SCL_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS SCL_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS SCL_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS SCL_EMPLOYEE_ID,
    AGENT_NO AS SCL_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS SCL_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS SCL_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS SCL_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS SCL_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS SCL_CANCEL_CD,
    CANCEL_PREMIUM_AM AS SCL_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS SCL_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS SCL_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS SCL_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS SCL_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS SCL_LOAN_ELIGIBLE,
    CPL_DT AS SCL_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS SCL_INCENTIVE_EMPLOYEE_ID
FROM Unique_SCL;

-- SCA (Single Credit Accident)
CREATE OR REPLACE TEMP VIEW view_SCA_flags AS
WITH Unique_SCA AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'SCA' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_SCA_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_SCA_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_SCA_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCA_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCA_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SCA_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_SCA_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS SCA_LIFECYCLE_STATUS,
    COVERAGE_ID AS SCA_COVERAGE_ID,
    POLICY_ID AS SCA_POLICY_ID,
    SALES_TYPE AS SCA_SALES_TYPE,
    BIF_BRANCH_NO AS SCA_BIF_BRANCH_NO,
    CERTIFICATE_NO AS SCA_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS SCA_SALE_MONTH_END_DT,
    SALE_CT AS SCA_SALE_CT,
    CANCEL_MONTH_END_DT AS SCA_CANCEL_MONTH_END_DT,
    CANCEL_CT AS SCA_CANCEL_CT,
    CANCEL_30DAY_CT AS SCA_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS SCA_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS SCA_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS SCA_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS SCA_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS SCA_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS SCA_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS SCA_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS SCA_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS SCA_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS SCA_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS SCA_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS SCA_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS SCA_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS SCA_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS SCA_EMPLOYEE_ID,
    AGENT_NO AS SCA_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS SCA_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS SCA_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS SCA_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS SCA_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS SCA_CANCEL_CD,
    CANCEL_PREMIUM_AM AS SCA_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS SCA_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS SCA_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS SCA_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS SCA_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS SCA_LOAN_ELIGIBLE,
    CPL_DT AS SCA_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS SCA_INCENTIVE_EMPLOYEE_ID
FROM Unique_SCA;

-- IUI (Involuntary Unemployment)
CREATE OR REPLACE TEMP VIEW view_IUI_flags AS
WITH Unique_IUI AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'IUI' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_IUI_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_IUI_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_IUI_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_IUI_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_IUI_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_IUI_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_IUI_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS IUI_LIFECYCLE_STATUS,
    COVERAGE_ID AS IUI_COVERAGE_ID,
    POLICY_ID AS IUI_POLICY_ID,
    SALES_TYPE AS IUI_SALES_TYPE,
    BIF_BRANCH_NO AS IUI_BIF_BRANCH_NO,
    CERTIFICATE_NO AS IUI_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS IUI_SALE_MONTH_END_DT,
    SALE_CT AS IUI_SALE_CT,
    CANCEL_MONTH_END_DT AS IUI_CANCEL_MONTH_END_DT,
    CANCEL_CT AS IUI_CANCEL_CT,
    CANCEL_30DAY_CT AS IUI_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS IUI_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS IUI_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS IUI_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS IUI_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS IUI_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS IUI_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS IUI_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS IUI_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS IUI_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS IUI_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS IUI_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS IUI_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS IUI_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS IUI_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS IUI_EMPLOYEE_ID,
    AGENT_NO AS IUI_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS IUI_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS IUI_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS IUI_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS IUI_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS IUI_CANCEL_CD,
    CANCEL_PREMIUM_AM AS IUI_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS IUI_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS IUI_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS IUI_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS IUI_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS IUI_LOAN_ELIGIBLE,
    CPL_DT AS IUI_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS IUI_INCENTIVE_EMPLOYEE_ID
FROM Unique_IUI;

-- GAP (Guaranteed Asset Protection)
CREATE OR REPLACE TEMP VIEW view_GAP_flags AS
WITH Unique_GAP AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'GAP' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_GAP_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_GAP_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_GAP_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_GAP_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_GAP_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_GAP_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_GAP_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS GAP_LIFECYCLE_STATUS,
    COVERAGE_ID AS GAP_COVERAGE_ID,
    POLICY_ID AS GAP_POLICY_ID,
    SALES_TYPE AS GAP_SALES_TYPE,
    BIF_BRANCH_NO AS GAP_BIF_BRANCH_NO,
    CERTIFICATE_NO AS GAP_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS GAP_SALE_MONTH_END_DT,
    SALE_CT AS GAP_SALE_CT,
    CANCEL_MONTH_END_DT AS GAP_CANCEL_MONTH_END_DT,
    CANCEL_CT AS GAP_CANCEL_CT,
    CANCEL_30DAY_CT AS GAP_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS GAP_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS GAP_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS GAP_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS GAP_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS GAP_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS GAP_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS GAP_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS GAP_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS GAP_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS GAP_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS GAP_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS GAP_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS GAP_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS GAP_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS GAP_EMPLOYEE_ID,
    AGENT_NO AS GAP_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS GAP_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS GAP_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS GAP_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS GAP_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS GAP_CANCEL_CD,
    CANCEL_PREMIUM_AM AS GAP_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS GAP_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS GAP_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS GAP_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS GAP_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS GAP_LOAN_ELIGIBLE,
    CPL_DT AS GAP_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS GAP_INCENTIVE_EMPLOYEE_ID
FROM Unique_GAP;

-- AUT (Auto / Vehicle Service Contract)
CREATE OR REPLACE TEMP VIEW view_AUT_flags AS
WITH Unique_AUT AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'AUT' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_AUT_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_AUT_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_AUT_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_AUT_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_AUT_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_AUT_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_AUT_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS AUT_LIFECYCLE_STATUS,
    COVERAGE_ID AS AUT_COVERAGE_ID,
    POLICY_ID AS AUT_POLICY_ID,
    SALES_TYPE AS AUT_SALES_TYPE,
    BIF_BRANCH_NO AS AUT_BIF_BRANCH_NO,
    CERTIFICATE_NO AS AUT_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS AUT_SALE_MONTH_END_DT,
    SALE_CT AS AUT_SALE_CT,
    CANCEL_MONTH_END_DT AS AUT_CANCEL_MONTH_END_DT,
    CANCEL_CT AS AUT_CANCEL_CT,
    CANCEL_30DAY_CT AS AUT_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS AUT_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS AUT_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS AUT_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS AUT_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS AUT_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS AUT_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS AUT_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS AUT_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS AUT_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS AUT_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS AUT_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS AUT_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS AUT_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS AUT_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS AUT_EMPLOYEE_ID,
    AGENT_NO AS AUT_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS AUT_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS AUT_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS AUT_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS AUT_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS AUT_CANCEL_CD,
    CANCEL_PREMIUM_AM AS AUT_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS AUT_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS AUT_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS AUT_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS AUT_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS AUT_LOAN_ELIGIBLE,
    CPL_DT AS AUT_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS AUT_INCENTIVE_EMPLOYEE_ID
FROM Unique_AUT;

-- HA (Hospital Accident)
CREATE OR REPLACE TEMP VIEW view_HA_flags AS
WITH Unique_HA AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'HA' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_HA_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_HA_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_HA_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_HA_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_HA_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_HA_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_HA_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS HA_LIFECYCLE_STATUS,
    COVERAGE_ID AS HA_COVERAGE_ID,
    POLICY_ID AS HA_POLICY_ID,
    SALES_TYPE AS HA_SALES_TYPE,
    BIF_BRANCH_NO AS HA_BIF_BRANCH_NO,
    CERTIFICATE_NO AS HA_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS HA_SALE_MONTH_END_DT,
    SALE_CT AS HA_SALE_CT,
    CANCEL_MONTH_END_DT AS HA_CANCEL_MONTH_END_DT,
    CANCEL_CT AS HA_CANCEL_CT,
    CANCEL_30DAY_CT AS HA_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS HA_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS HA_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS HA_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS HA_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS HA_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS HA_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS HA_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS HA_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS HA_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS HA_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS HA_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS HA_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS HA_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS HA_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS HA_EMPLOYEE_ID,
    AGENT_NO AS HA_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS HA_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS HA_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS HA_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS HA_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS HA_CANCEL_CD,
    CANCEL_PREMIUM_AM AS HA_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS HA_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS HA_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS HA_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS HA_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS HA_LOAN_ELIGIBLE,
    CPL_DT AS HA_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS HA_INCENTIVE_EMPLOYEE_ID
FROM Unique_HA;

-- ATL (Auto Term Life)
CREATE OR REPLACE TEMP VIEW view_ATL_flags AS
WITH Unique_ATL AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'ATL' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_ATL_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_ATL_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_ATL_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_ATL_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_ATL_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_ATL_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_ATL_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS ATL_LIFECYCLE_STATUS,
    COVERAGE_ID AS ATL_COVERAGE_ID,
    POLICY_ID AS ATL_POLICY_ID,
    SALES_TYPE AS ATL_SALES_TYPE,
    BIF_BRANCH_NO AS ATL_BIF_BRANCH_NO,
    CERTIFICATE_NO AS ATL_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS ATL_SALE_MONTH_END_DT,
    SALE_CT AS ATL_SALE_CT,
    CANCEL_MONTH_END_DT AS ATL_CANCEL_MONTH_END_DT,
    CANCEL_CT AS ATL_CANCEL_CT,
    CANCEL_30DAY_CT AS ATL_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS ATL_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS ATL_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS ATL_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS ATL_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS ATL_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS ATL_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS ATL_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS ATL_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS ATL_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS ATL_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS ATL_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS ATL_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS ATL_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS ATL_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS ATL_EMPLOYEE_ID,
    AGENT_NO AS ATL_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS ATL_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS ATL_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS ATL_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS ATL_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS ATL_CANCEL_CD,
    CANCEL_PREMIUM_AM AS ATL_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS ATL_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS ATL_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS ATL_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS ATL_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS ATL_LOAN_ELIGIBLE,
    CPL_DT AS ATL_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS ATL_INCENTIVE_EMPLOYEE_ID
FROM Unique_ATL;

-- SSG (Supplemental Security / Other)
CREATE OR REPLACE TEMP VIEW view_SSG_flags AS
WITH Unique_SSG AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'SSG' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_SSG_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_SSG_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_SSG_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SSG_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SSG_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_SSG_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_SSG_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS SSG_LIFECYCLE_STATUS,
    COVERAGE_ID AS SSG_COVERAGE_ID,
    POLICY_ID AS SSG_POLICY_ID,
    SALES_TYPE AS SSG_SALES_TYPE,
    BIF_BRANCH_NO AS SSG_BIF_BRANCH_NO,
    CERTIFICATE_NO AS SSG_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS SSG_SALE_MONTH_END_DT,
    SALE_CT AS SSG_SALE_CT,
    CANCEL_MONTH_END_DT AS SSG_CANCEL_MONTH_END_DT,
    CANCEL_CT AS SSG_CANCEL_CT,
    CANCEL_30DAY_CT AS SSG_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS SSG_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS SSG_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS SSG_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS SSG_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS SSG_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS SSG_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS SSG_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS SSG_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS SSG_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS SSG_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS SSG_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS SSG_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS SSG_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS SSG_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS SSG_EMPLOYEE_ID,
    AGENT_NO AS SSG_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS SSG_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS SSG_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS SSG_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS SSG_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS SSG_CANCEL_CD,
    CANCEL_PREMIUM_AM AS SSG_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS SSG_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS SSG_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS SSG_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS SSG_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS SSG_LOAN_ELIGIBLE,
    CPL_DT AS SSG_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS SSG_INCENTIVE_EMPLOYEE_ID
FROM Unique_SSG;

-- DIP (Disability Income Plus)
CREATE OR REPLACE TEMP VIEW view_DIP_flags AS
WITH Unique_DIP AS (
    SELECT *
    FROM core.optional_product_sale
    WHERE coverage_abbreviation_cd = 'DIP' AND LOAN_ELIGIBLE = 'Y'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY uai_id, score_branch_no ORDER BY SALE_CT DESC, CANCEL_CT DESC, RECORD_UPDATE_TS DESC) = 1
)
SELECT 
    uai_id, score_branch_no,
    1 AS IS_DIP_ELIGIBLE,
    CASE WHEN SALE_CT > 0 THEN 1 ELSE 0 END AS IS_DIP_GROSS_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) = 0 THEN 1 ELSE 0 END AS IS_DIP_NET_SOLD,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_DIP_CANCELED,
    
    -- New Flags
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_30DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_DIP_CANCEL_WITHIN_30DAYS,
    CASE WHEN SALE_CT > 0 AND COALESCE(CANCEL_60DAY_CT, 0) > 0 THEN 1 ELSE 0 END AS IS_DIP_CANCEL_WITHIN_60DAYS,
    CASE WHEN SALE_CT > 0 AND CUSTOMER_INITIATED_CANCEL_YN = 'Y' THEN 1 ELSE 0 END AS IS_DIP_CUSTOMER_INITIATED_CANCEL,
    
    CASE 
        WHEN SALE_CT > 0 AND COALESCE(CANCEL_CT, 0) > 0 THEN '4. Sold - Canceled'
        WHEN SALE_CT > 0 THEN '3. Sold - Active'
        ELSE '2. Eligible - Waived'
    END AS DIP_LIFECYCLE_STATUS,
    COVERAGE_ID AS DIP_COVERAGE_ID,
    POLICY_ID AS DIP_POLICY_ID,
    SALES_TYPE AS DIP_SALES_TYPE,
    BIF_BRANCH_NO AS DIP_BIF_BRANCH_NO,
    CERTIFICATE_NO AS DIP_CERTIFICATE_NO,
    SALE_MONTH_END_DT AS DIP_SALE_MONTH_END_DT,
    SALE_CT AS DIP_SALE_CT,
    CANCEL_MONTH_END_DT AS DIP_CANCEL_MONTH_END_DT,
    CANCEL_CT AS DIP_CANCEL_CT,
    CANCEL_30DAY_CT AS DIP_CANCEL_30DAY_CT,
    CANCEL_60DAY_CT AS DIP_CANCEL_60DAY_CT,
    CUSTOMER_INITIATED_CANCEL_YN AS DIP_CUSTOMER_INITIATED_CANCEL_YN,
    COVERAGE_EFFECTIVE_DT AS DIP_COVERAGE_EFFECTIVE_DT,
    COVERAGE_ACCOUNTING_DT AS DIP_COVERAGE_ACCOUNTING_DT,
    COVERAGE_SEQUENCE_NO AS DIP_COVERAGE_SEQUENCE_NO,
    COVERAGE_CD AS DIP_COVERAGE_CD,
    ORIGINAL_PREMIUM_AM AS DIP_ORIGINAL_PREMIUM_AM,
    NONCREDIT_FIRST_PAYMENT_DT AS DIP_NONCREDIT_FIRST_PAYMENT_DT,
    COVERAGE_ABBREVIATION_CD AS DIP_COVERAGE_ABBREVIATION_CD,
    SINGLE_JOINT_CD AS DIP_SINGLE_JOINT_CD,
    COVERAGE_TYPE_CD AS DIP_COVERAGE_TYPE_CD,
    COVERAGE_PRODUCT_LINE_CD AS DIP_COVERAGE_PRODUCT_LINE_CD,
    COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION AS DIP_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION AS DIP_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    EMPLOYEE_ID AS DIP_EMPLOYEE_ID,
    AGENT_NO AS DIP_AGENT_NO,
    CANCEL_EFFECTIVE_DT AS DIP_CANCEL_EFFECTIVE_DT,
    CANCEL_ACCOUNTING_DT AS DIP_CANCEL_ACCOUNTING_DT,
    CANCEL_BIF_BRANCH_NO AS DIP_CANCEL_BIF_BRANCH_NO,
    CANCEL_SCORE_BRANCH_NO AS DIP_CANCEL_SCORE_BRANCH_NO,
    CANCEL_CD AS DIP_CANCEL_CD,
    CANCEL_PREMIUM_AM AS DIP_CANCEL_PREMIUM_AM,
    COVERAGE_LOAD_TS AS DIP_COVERAGE_LOAD_TS,
    CANCEL_LOAD_TS AS DIP_CANCEL_LOAD_TS,
    RECORD_CREATED_TS AS DIP_RECORD_CREATED_TS,
    RECORD_UPDATE_TS AS DIP_RECORD_UPDATE_TS,
    LOAN_ELIGIBLE AS DIP_LOAN_ELIGIBLE,
    CPL_DT AS DIP_CPL_DT,
    INCENTIVE_EMPLOYEE_ID AS DIP_INCENTIVE_EMPLOYEE_ID
FROM Unique_DIP;

-- ====================================================================
-- PHASE 2: FINAL MASTER JOIN
-- ====================================================================
CREATE OR REPLACE TEMP TABLE optional_product_master AS
SELECT 
    A.*, 

    -- SCL
    COALESCE(SCL.IS_SCL_ELIGIBLE, 0)   AS IS_SCL_ELIGIBLE,
    COALESCE(SCL.IS_SCL_GROSS_SOLD, 0) AS IS_SCL_GROSS_SOLD,
    COALESCE(SCL.IS_SCL_NET_SOLD, 0)   AS IS_SCL_NET_SOLD,
    COALESCE(SCL.IS_SCL_CANCELED, 0)   AS IS_SCL_CANCELED,
    COALESCE(SCL.IS_SCL_CANCEL_WITHIN_30DAYS, 0)   AS IS_SCL_CANCEL_WITHIN_30DAYS,
    COALESCE(SCL.IS_SCL_CANCEL_WITHIN_60DAYS, 0)   AS IS_SCL_CANCEL_WITHIN_60DAYS,
    COALESCE(SCL.IS_SCL_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_SCL_CUSTOMER_INITIATED_CANCEL,
    COALESCE(SCL.SCL_LIFECYCLE_STATUS, '1. Not Eligible') AS SCL_LIFECYCLE_STATUS,
    SCL.SCL_COVERAGE_ID,
    SCL.SCL_POLICY_ID,
    SCL.SCL_SALES_TYPE,
    SCL.SCL_BIF_BRANCH_NO,
    SCL.SCL_CERTIFICATE_NO,
    SCL.SCL_SALE_MONTH_END_DT,
    SCL.SCL_SALE_CT,
    SCL.SCL_CANCEL_MONTH_END_DT,
    SCL.SCL_CANCEL_CT,
    SCL.SCL_CANCEL_30DAY_CT,
    SCL.SCL_CANCEL_60DAY_CT,
    SCL.SCL_CUSTOMER_INITIATED_CANCEL_YN,
    SCL.SCL_COVERAGE_EFFECTIVE_DT,
    SCL.SCL_COVERAGE_ACCOUNTING_DT,
    SCL.SCL_COVERAGE_SEQUENCE_NO,
    SCL.SCL_COVERAGE_CD,
    SCL.SCL_ORIGINAL_PREMIUM_AM,
    SCL.SCL_NONCREDIT_FIRST_PAYMENT_DT,
    SCL.SCL_COVERAGE_ABBREVIATION_CD,
    SCL.SCL_SINGLE_JOINT_CD,
    SCL.SCL_COVERAGE_TYPE_CD,
    SCL.SCL_COVERAGE_PRODUCT_LINE_CD,
    SCL.SCL_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    SCL.SCL_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    SCL.SCL_EMPLOYEE_ID,
    SCL.SCL_AGENT_NO,
    SCL.SCL_CANCEL_EFFECTIVE_DT,
    SCL.SCL_CANCEL_ACCOUNTING_DT,
    SCL.SCL_CANCEL_BIF_BRANCH_NO,
    SCL.SCL_CANCEL_SCORE_BRANCH_NO,
    SCL.SCL_CANCEL_CD,
    SCL.SCL_CANCEL_PREMIUM_AM,
    SCL.SCL_COVERAGE_LOAD_TS,
    SCL.SCL_CANCEL_LOAD_TS,
    SCL.SCL_RECORD_CREATED_TS,
    SCL.SCL_RECORD_UPDATE_TS,
    SCL.SCL_LOAN_ELIGIBLE,
    SCL.SCL_CPL_DT,
    SCL.SCL_INCENTIVE_EMPLOYEE_ID,

    -- SCA
    COALESCE(SCA.IS_SCA_ELIGIBLE, 0)   AS IS_SCA_ELIGIBLE,
    COALESCE(SCA.IS_SCA_GROSS_SOLD, 0) AS IS_SCA_GROSS_SOLD,
    COALESCE(SCA.IS_SCA_NET_SOLD, 0)   AS IS_SCA_NET_SOLD,
    COALESCE(SCA.IS_SCA_CANCELED, 0)   AS IS_SCA_CANCELED,
    COALESCE(SCA.IS_SCA_CANCEL_WITHIN_30DAYS, 0)   AS IS_SCA_CANCEL_WITHIN_30DAYS,
    COALESCE(SCA.IS_SCA_CANCEL_WITHIN_60DAYS, 0)   AS IS_SCA_CANCEL_WITHIN_60DAYS,
    COALESCE(SCA.IS_SCA_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_SCA_CUSTOMER_INITIATED_CANCEL,
    COALESCE(SCA.SCA_LIFECYCLE_STATUS, '1. Not Eligible') AS SCA_LIFECYCLE_STATUS,
    SCA.SCA_COVERAGE_ID,
    SCA.SCA_POLICY_ID,
    SCA.SCA_SALES_TYPE,
    SCA.SCA_BIF_BRANCH_NO,
    SCA.SCA_CERTIFICATE_NO,
    SCA.SCA_SALE_MONTH_END_DT,
    SCA.SCA_SALE_CT,
    SCA.SCA_CANCEL_MONTH_END_DT,
    SCA.SCA_CANCEL_CT,
    SCA.SCA_CANCEL_30DAY_CT,
    SCA.SCA_CANCEL_60DAY_CT,
    SCA.SCA_CUSTOMER_INITIATED_CANCEL_YN,
    SCA.SCA_COVERAGE_EFFECTIVE_DT,
    SCA.SCA_COVERAGE_ACCOUNTING_DT,
    SCA.SCA_COVERAGE_SEQUENCE_NO,
    SCA.SCA_COVERAGE_CD,
    SCA.SCA_ORIGINAL_PREMIUM_AM,
    SCA.SCA_NONCREDIT_FIRST_PAYMENT_DT,
    SCA.SCA_COVERAGE_ABBREVIATION_CD,
    SCA.SCA_SINGLE_JOINT_CD,
    SCA.SCA_COVERAGE_TYPE_CD,
    SCA.SCA_COVERAGE_PRODUCT_LINE_CD,
    SCA.SCA_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    SCA.SCA_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    SCA.SCA_EMPLOYEE_ID,
    SCA.SCA_AGENT_NO,
    SCA.SCA_CANCEL_EFFECTIVE_DT,
    SCA.SCA_CANCEL_ACCOUNTING_DT,
    SCA.SCA_CANCEL_BIF_BRANCH_NO,
    SCA.SCA_CANCEL_SCORE_BRANCH_NO,
    SCA.SCA_CANCEL_CD,
    SCA.SCA_CANCEL_PREMIUM_AM,
    SCA.SCA_COVERAGE_LOAD_TS,
    SCA.SCA_CANCEL_LOAD_TS,
    SCA.SCA_RECORD_CREATED_TS,
    SCA.SCA_RECORD_UPDATE_TS,
    SCA.SCA_LOAN_ELIGIBLE,
    SCA.SCA_CPL_DT,
    SCA.SCA_INCENTIVE_EMPLOYEE_ID,

    -- IUI
    COALESCE(IUI.IS_IUI_ELIGIBLE, 0)   AS IS_IUI_ELIGIBLE,
    COALESCE(IUI.IS_IUI_GROSS_SOLD, 0) AS IS_IUI_GROSS_SOLD,
    COALESCE(IUI.IS_IUI_NET_SOLD, 0)   AS IS_IUI_NET_SOLD,
    COALESCE(IUI.IS_IUI_CANCELED, 0)   AS IS_IUI_CANCELED,
    COALESCE(IUI.IS_IUI_CANCEL_WITHIN_30DAYS, 0)   AS IS_IUI_CANCEL_WITHIN_30DAYS,
    COALESCE(IUI.IS_IUI_CANCEL_WITHIN_60DAYS, 0)   AS IS_IUI_CANCEL_WITHIN_60DAYS,
    COALESCE(IUI.IS_IUI_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_IUI_CUSTOMER_INITIATED_CANCEL,
    COALESCE(IUI.IUI_LIFECYCLE_STATUS, '1. Not Eligible') AS IUI_LIFECYCLE_STATUS,
    IUI.IUI_COVERAGE_ID,
    IUI.IUI_POLICY_ID,
    IUI.IUI_SALES_TYPE,
    IUI.IUI_BIF_BRANCH_NO,
    IUI.IUI_CERTIFICATE_NO,
    IUI.IUI_SALE_MONTH_END_DT,
    IUI.IUI_SALE_CT,
    IUI.IUI_CANCEL_MONTH_END_DT,
    IUI.IUI_CANCEL_CT,
    IUI.IUI_CANCEL_30DAY_CT,
    IUI.IUI_CANCEL_60DAY_CT,
    IUI.IUI_CUSTOMER_INITIATED_CANCEL_YN,
    IUI.IUI_COVERAGE_EFFECTIVE_DT,
    IUI.IUI_COVERAGE_ACCOUNTING_DT,
    IUI.IUI_COVERAGE_SEQUENCE_NO,
    IUI.IUI_COVERAGE_CD,
    IUI.IUI_ORIGINAL_PREMIUM_AM,
    IUI.IUI_NONCREDIT_FIRST_PAYMENT_DT,
    IUI.IUI_COVERAGE_ABBREVIATION_CD,
    IUI.IUI_SINGLE_JOINT_CD,
    IUI.IUI_COVERAGE_TYPE_CD,
    IUI.IUI_COVERAGE_PRODUCT_LINE_CD,
    IUI.IUI_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    IUI.IUI_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    IUI.IUI_EMPLOYEE_ID,
    IUI.IUI_AGENT_NO,
    IUI.IUI_CANCEL_EFFECTIVE_DT,
    IUI.IUI_CANCEL_ACCOUNTING_DT,
    IUI.IUI_CANCEL_BIF_BRANCH_NO,
    IUI.IUI_CANCEL_SCORE_BRANCH_NO,
    IUI.IUI_CANCEL_CD,
    IUI.IUI_CANCEL_PREMIUM_AM,
    IUI.IUI_COVERAGE_LOAD_TS,
    IUI.IUI_CANCEL_LOAD_TS,
    IUI.IUI_RECORD_CREATED_TS,
    IUI.IUI_RECORD_UPDATE_TS,
    IUI.IUI_LOAN_ELIGIBLE,
    IUI.IUI_CPL_DT,
    IUI.IUI_INCENTIVE_EMPLOYEE_ID,

    -- GAP
    COALESCE(GAP.IS_GAP_ELIGIBLE, 0)   AS IS_GAP_ELIGIBLE,
    COALESCE(GAP.IS_GAP_GROSS_SOLD, 0) AS IS_GAP_GROSS_SOLD,
    COALESCE(GAP.IS_GAP_NET_SOLD, 0)   AS IS_GAP_NET_SOLD,
    COALESCE(GAP.IS_GAP_CANCELED, 0)   AS IS_GAP_CANCELED,
    COALESCE(GAP.IS_GAP_CANCEL_WITHIN_30DAYS, 0)   AS IS_GAP_CANCEL_WITHIN_30DAYS,
    COALESCE(GAP.IS_GAP_CANCEL_WITHIN_60DAYS, 0)   AS IS_GAP_CANCEL_WITHIN_60DAYS,
    COALESCE(GAP.IS_GAP_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_GAP_CUSTOMER_INITIATED_CANCEL,
    COALESCE(GAP.GAP_LIFECYCLE_STATUS, '1. Not Eligible') AS GAP_LIFECYCLE_STATUS,
    GAP.GAP_COVERAGE_ID,
    GAP.GAP_POLICY_ID,
    GAP.GAP_SALES_TYPE,
    GAP.GAP_BIF_BRANCH_NO,
    GAP.GAP_CERTIFICATE_NO,
    GAP.GAP_SALE_MONTH_END_DT,
    GAP.GAP_SALE_CT,
    GAP.GAP_CANCEL_MONTH_END_DT,
    GAP.GAP_CANCEL_CT,
    GAP.GAP_CANCEL_30DAY_CT,
    GAP.GAP_CANCEL_60DAY_CT,
    GAP.GAP_CUSTOMER_INITIATED_CANCEL_YN,
    GAP.GAP_COVERAGE_EFFECTIVE_DT,
    GAP.GAP_COVERAGE_ACCOUNTING_DT,
    GAP.GAP_COVERAGE_SEQUENCE_NO,
    GAP.GAP_COVERAGE_CD,
    GAP.GAP_ORIGINAL_PREMIUM_AM,
    GAP.GAP_NONCREDIT_FIRST_PAYMENT_DT,
    GAP.GAP_COVERAGE_ABBREVIATION_CD,
    GAP.GAP_SINGLE_JOINT_CD,
    GAP.GAP_COVERAGE_TYPE_CD,
    GAP.GAP_COVERAGE_PRODUCT_LINE_CD,
    GAP.GAP_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    GAP.GAP_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    GAP.GAP_EMPLOYEE_ID,
    GAP.GAP_AGENT_NO,
    GAP.GAP_CANCEL_EFFECTIVE_DT,
    GAP.GAP_CANCEL_ACCOUNTING_DT,
    GAP.GAP_CANCEL_BIF_BRANCH_NO,
    GAP.GAP_CANCEL_SCORE_BRANCH_NO,
    GAP.GAP_CANCEL_CD,
    GAP.GAP_CANCEL_PREMIUM_AM,
    GAP.GAP_COVERAGE_LOAD_TS,
    GAP.GAP_CANCEL_LOAD_TS,
    GAP.GAP_RECORD_CREATED_TS,
    GAP.GAP_RECORD_UPDATE_TS,
    GAP.GAP_LOAN_ELIGIBLE,
    GAP.GAP_CPL_DT,
    GAP.GAP_INCENTIVE_EMPLOYEE_ID,

    -- AUT
    COALESCE(AUT.IS_AUT_ELIGIBLE, 0)   AS IS_AUT_ELIGIBLE,
    COALESCE(AUT.IS_AUT_GROSS_SOLD, 0) AS IS_AUT_GROSS_SOLD,
    COALESCE(AUT.IS_AUT_NET_SOLD, 0)   AS IS_AUT_NET_SOLD,
    COALESCE(AUT.IS_AUT_CANCELED, 0)   AS IS_AUT_CANCELED,
    COALESCE(AUT.IS_AUT_CANCEL_WITHIN_30DAYS, 0)   AS IS_AUT_CANCEL_WITHIN_30DAYS,
    COALESCE(AUT.IS_AUT_CANCEL_WITHIN_60DAYS, 0)   AS IS_AUT_CANCEL_WITHIN_60DAYS,
    COALESCE(AUT.IS_AUT_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_AUT_CUSTOMER_INITIATED_CANCEL,
    COALESCE(AUT.AUT_LIFECYCLE_STATUS, '1. Not Eligible') AS AUT_LIFECYCLE_STATUS,
    AUT.AUT_COVERAGE_ID,
    AUT.AUT_POLICY_ID,
    AUT.AUT_SALES_TYPE,
    AUT.AUT_BIF_BRANCH_NO,
    AUT.AUT_CERTIFICATE_NO,
    AUT.AUT_SALE_MONTH_END_DT,
    AUT.AUT_SALE_CT,
    AUT.AUT_CANCEL_MONTH_END_DT,
    AUT.AUT_CANCEL_CT,
    AUT.AUT_CANCEL_30DAY_CT,
    AUT.AUT_CANCEL_60DAY_CT,
    AUT.AUT_CUSTOMER_INITIATED_CANCEL_YN,
    AUT.AUT_COVERAGE_EFFECTIVE_DT,
    AUT.AUT_COVERAGE_ACCOUNTING_DT,
    AUT.AUT_COVERAGE_SEQUENCE_NO,
    AUT.AUT_COVERAGE_CD,
    AUT.AUT_ORIGINAL_PREMIUM_AM,
    AUT.AUT_NONCREDIT_FIRST_PAYMENT_DT,
    AUT.AUT_COVERAGE_ABBREVIATION_CD,
    AUT.AUT_SINGLE_JOINT_CD,
    AUT.AUT_COVERAGE_TYPE_CD,
    AUT.AUT_COVERAGE_PRODUCT_LINE_CD,
    AUT.AUT_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    AUT.AUT_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    AUT.AUT_EMPLOYEE_ID,
    AUT.AUT_AGENT_NO,
    AUT.AUT_CANCEL_EFFECTIVE_DT,
    AUT.AUT_CANCEL_ACCOUNTING_DT,
    AUT.AUT_CANCEL_BIF_BRANCH_NO,
    AUT.AUT_CANCEL_SCORE_BRANCH_NO,
    AUT.AUT_CANCEL_CD,
    AUT.AUT_CANCEL_PREMIUM_AM,
    AUT.AUT_COVERAGE_LOAD_TS,
    AUT.AUT_CANCEL_LOAD_TS,
    AUT.AUT_RECORD_CREATED_TS,
    AUT.AUT_RECORD_UPDATE_TS,
    AUT.AUT_LOAN_ELIGIBLE,
    AUT.AUT_CPL_DT,
    AUT.AUT_INCENTIVE_EMPLOYEE_ID,

    -- HA
    COALESCE(HA.IS_HA_ELIGIBLE, 0)   AS IS_HA_ELIGIBLE,
    COALESCE(HA.IS_HA_GROSS_SOLD, 0) AS IS_HA_GROSS_SOLD,
    COALESCE(HA.IS_HA_NET_SOLD, 0)   AS IS_HA_NET_SOLD,
    COALESCE(HA.IS_HA_CANCELED, 0)   AS IS_HA_CANCELED,
    COALESCE(HA.IS_HA_CANCEL_WITHIN_30DAYS, 0)   AS IS_HA_CANCEL_WITHIN_30DAYS,
    COALESCE(HA.IS_HA_CANCEL_WITHIN_60DAYS, 0)   AS IS_HA_CANCEL_WITHIN_60DAYS,
    COALESCE(HA.IS_HA_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_HA_CUSTOMER_INITIATED_CANCEL,
    COALESCE(HA.HA_LIFECYCLE_STATUS, '1. Not Eligible') AS HA_LIFECYCLE_STATUS,
    HA.HA_COVERAGE_ID,
    HA.HA_POLICY_ID,
    HA.HA_SALES_TYPE,
    HA.HA_BIF_BRANCH_NO,
    HA.HA_CERTIFICATE_NO,
    HA.HA_SALE_MONTH_END_DT,
    HA.HA_SALE_CT,
    HA.HA_CANCEL_MONTH_END_DT,
    HA.HA_CANCEL_CT,
    HA.HA_CANCEL_30DAY_CT,
    HA.HA_CANCEL_60DAY_CT,
    HA.HA_CUSTOMER_INITIATED_CANCEL_YN,
    HA.HA_COVERAGE_EFFECTIVE_DT,
    HA.HA_COVERAGE_ACCOUNTING_DT,
    HA.HA_COVERAGE_SEQUENCE_NO,
    HA.HA_COVERAGE_CD,
    HA.HA_ORIGINAL_PREMIUM_AM,
    HA.HA_NONCREDIT_FIRST_PAYMENT_DT,
    HA.HA_COVERAGE_ABBREVIATION_CD,
    HA.HA_SINGLE_JOINT_CD,
    HA.HA_COVERAGE_TYPE_CD,
    HA.HA_COVERAGE_PRODUCT_LINE_CD,
    HA.HA_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    HA.HA_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    HA.HA_EMPLOYEE_ID,
    HA.HA_AGENT_NO,
    HA.HA_CANCEL_EFFECTIVE_DT,
    HA.HA_CANCEL_ACCOUNTING_DT,
    HA.HA_CANCEL_BIF_BRANCH_NO,
    HA.HA_CANCEL_SCORE_BRANCH_NO,
    HA.HA_CANCEL_CD,
    HA.HA_CANCEL_PREMIUM_AM,
    HA.HA_COVERAGE_LOAD_TS,
    HA.HA_CANCEL_LOAD_TS,
    HA.HA_RECORD_CREATED_TS,
    HA.HA_RECORD_UPDATE_TS,
    HA.HA_LOAN_ELIGIBLE,
    HA.HA_CPL_DT,
    HA.HA_INCENTIVE_EMPLOYEE_ID,

    -- ATL
    COALESCE(ATL.IS_ATL_ELIGIBLE, 0)   AS IS_ATL_ELIGIBLE,
    COALESCE(ATL.IS_ATL_GROSS_SOLD, 0) AS IS_ATL_GROSS_SOLD,
    COALESCE(ATL.IS_ATL_NET_SOLD, 0)   AS IS_ATL_NET_SOLD,
    COALESCE(ATL.IS_ATL_CANCELED, 0)   AS IS_ATL_CANCELED,
    COALESCE(ATL.IS_ATL_CANCEL_WITHIN_30DAYS, 0)   AS IS_ATL_CANCEL_WITHIN_30DAYS,
    COALESCE(ATL.IS_ATL_CANCEL_WITHIN_60DAYS, 0)   AS IS_ATL_CANCEL_WITHIN_60DAYS,
    COALESCE(ATL.IS_ATL_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_ATL_CUSTOMER_INITIATED_CANCEL,
    COALESCE(ATL.ATL_LIFECYCLE_STATUS, '1. Not Eligible') AS ATL_LIFECYCLE_STATUS,
    ATL.ATL_COVERAGE_ID,
    ATL.ATL_POLICY_ID,
    ATL.ATL_SALES_TYPE,
    ATL.ATL_BIF_BRANCH_NO,
    ATL.ATL_CERTIFICATE_NO,
    ATL.ATL_SALE_MONTH_END_DT,
    ATL.ATL_SALE_CT,
    ATL.ATL_CANCEL_MONTH_END_DT,
    ATL.ATL_CANCEL_CT,
    ATL.ATL_CANCEL_30DAY_CT,
    ATL.ATL_CANCEL_60DAY_CT,
    ATL.ATL_CUSTOMER_INITIATED_CANCEL_YN,
    ATL.ATL_COVERAGE_EFFECTIVE_DT,
    ATL.ATL_COVERAGE_ACCOUNTING_DT,
    ATL.ATL_COVERAGE_SEQUENCE_NO,
    ATL.ATL_COVERAGE_CD,
    ATL.ATL_ORIGINAL_PREMIUM_AM,
    ATL.ATL_NONCREDIT_FIRST_PAYMENT_DT,
    ATL.ATL_COVERAGE_ABBREVIATION_CD,
    ATL.ATL_SINGLE_JOINT_CD,
    ATL.ATL_COVERAGE_TYPE_CD,
    ATL.ATL_COVERAGE_PRODUCT_LINE_CD,
    ATL.ATL_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    ATL.ATL_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    ATL.ATL_EMPLOYEE_ID,
    ATL.ATL_AGENT_NO,
    ATL.ATL_CANCEL_EFFECTIVE_DT,
    ATL.ATL_CANCEL_ACCOUNTING_DT,
    ATL.ATL_CANCEL_BIF_BRANCH_NO,
    ATL.ATL_CANCEL_SCORE_BRANCH_NO,
    ATL.ATL_CANCEL_CD,
    ATL.ATL_CANCEL_PREMIUM_AM,
    ATL.ATL_COVERAGE_LOAD_TS,
    ATL.ATL_CANCEL_LOAD_TS,
    ATL.ATL_RECORD_CREATED_TS,
    ATL.ATL_RECORD_UPDATE_TS,
    ATL.ATL_LOAN_ELIGIBLE,
    ATL.ATL_CPL_DT,
    ATL.ATL_INCENTIVE_EMPLOYEE_ID,

    -- SSG
    COALESCE(SSG.IS_SSG_ELIGIBLE, 0)   AS IS_SSG_ELIGIBLE,
    COALESCE(SSG.IS_SSG_GROSS_SOLD, 0) AS IS_SSG_GROSS_SOLD,
    COALESCE(SSG.IS_SSG_NET_SOLD, 0)   AS IS_SSG_NET_SOLD,
    COALESCE(SSG.IS_SSG_CANCELED, 0)   AS IS_SSG_CANCELED,
    COALESCE(SSG.IS_SSG_CANCEL_WITHIN_30DAYS, 0)   AS IS_SSG_CANCEL_WITHIN_30DAYS,
    COALESCE(SSG.IS_SSG_CANCEL_WITHIN_60DAYS, 0)   AS IS_SSG_CANCEL_WITHIN_60DAYS,
    COALESCE(SSG.IS_SSG_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_SSG_CUSTOMER_INITIATED_CANCEL,
    COALESCE(SSG.SSG_LIFECYCLE_STATUS, '1. Not Eligible') AS SSG_LIFECYCLE_STATUS,
    SSG.SSG_COVERAGE_ID,
    SSG.SSG_POLICY_ID,
    SSG.SSG_SALES_TYPE,
    SSG.SSG_BIF_BRANCH_NO,
    SSG.SSG_CERTIFICATE_NO,
    SSG.SSG_SALE_MONTH_END_DT,
    SSG.SSG_SALE_CT,
    SSG.SSG_CANCEL_MONTH_END_DT,
    SSG.SSG_CANCEL_CT,
    SSG.SSG_CANCEL_30DAY_CT,
    SSG.SSG_CANCEL_60DAY_CT,
    SSG.SSG_CUSTOMER_INITIATED_CANCEL_YN,
    SSG.SSG_COVERAGE_EFFECTIVE_DT,
    SSG.SSG_COVERAGE_ACCOUNTING_DT,
    SSG.SSG_COVERAGE_SEQUENCE_NO,
    SSG.SSG_COVERAGE_CD,
    SSG.SSG_ORIGINAL_PREMIUM_AM,
    SSG.SSG_NONCREDIT_FIRST_PAYMENT_DT,
    SSG.SSG_COVERAGE_ABBREVIATION_CD,
    SSG.SSG_SINGLE_JOINT_CD,
    SSG.SSG_COVERAGE_TYPE_CD,
    SSG.SSG_COVERAGE_PRODUCT_LINE_CD,
    SSG.SSG_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    SSG.SSG_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    SSG.SSG_EMPLOYEE_ID,
    SSG.SSG_AGENT_NO,
    SSG.SSG_CANCEL_EFFECTIVE_DT,
    SSG.SSG_CANCEL_ACCOUNTING_DT,
    SSG.SSG_CANCEL_BIF_BRANCH_NO,
    SSG.SSG_CANCEL_SCORE_BRANCH_NO,
    SSG.SSG_CANCEL_CD,
    SSG.SSG_CANCEL_PREMIUM_AM,
    SSG.SSG_COVERAGE_LOAD_TS,
    SSG.SSG_CANCEL_LOAD_TS,
    SSG.SSG_RECORD_CREATED_TS,
    SSG.SSG_RECORD_UPDATE_TS,
    SSG.SSG_LOAN_ELIGIBLE,
    SSG.SSG_CPL_DT,
    SSG.SSG_INCENTIVE_EMPLOYEE_ID,

    -- DIP
    COALESCE(DIP.IS_DIP_ELIGIBLE, 0)   AS IS_DIP_ELIGIBLE,
    COALESCE(DIP.IS_DIP_GROSS_SOLD, 0) AS IS_DIP_GROSS_SOLD,
    COALESCE(DIP.IS_DIP_NET_SOLD, 0)   AS IS_DIP_NET_SOLD,
    COALESCE(DIP.IS_DIP_CANCELED, 0)   AS IS_DIP_CANCELED,
    COALESCE(DIP.IS_DIP_CANCEL_WITHIN_30DAYS, 0)   AS IS_DIP_CANCEL_WITHIN_30DAYS,
    COALESCE(DIP.IS_DIP_CANCEL_WITHIN_60DAYS, 0)   AS IS_DIP_CANCEL_WITHIN_60DAYS,
    COALESCE(DIP.IS_DIP_CUSTOMER_INITIATED_CANCEL, 0)   AS IS_DIP_CUSTOMER_INITIATED_CANCEL,
    COALESCE(DIP.DIP_LIFECYCLE_STATUS, '1. Not Eligible') AS DIP_LIFECYCLE_STATUS,
    DIP.DIP_COVERAGE_ID,
    DIP.DIP_POLICY_ID,
    DIP.DIP_SALES_TYPE,
    DIP.DIP_BIF_BRANCH_NO,
    DIP.DIP_CERTIFICATE_NO,
    DIP.DIP_SALE_MONTH_END_DT,
    DIP.DIP_SALE_CT,
    DIP.DIP_CANCEL_MONTH_END_DT,
    DIP.DIP_CANCEL_CT,
    DIP.DIP_CANCEL_30DAY_CT,
    DIP.DIP_CANCEL_60DAY_CT,
    DIP.DIP_CUSTOMER_INITIATED_CANCEL_YN,
    DIP.DIP_COVERAGE_EFFECTIVE_DT,
    DIP.DIP_COVERAGE_ACCOUNTING_DT,
    DIP.DIP_COVERAGE_SEQUENCE_NO,
    DIP.DIP_COVERAGE_CD,
    DIP.DIP_ORIGINAL_PREMIUM_AM,
    DIP.DIP_NONCREDIT_FIRST_PAYMENT_DT,
    DIP.DIP_COVERAGE_ABBREVIATION_CD,
    DIP.DIP_SINGLE_JOINT_CD,
    DIP.DIP_COVERAGE_TYPE_CD,
    DIP.DIP_COVERAGE_PRODUCT_LINE_CD,
    DIP.DIP_COVERAGE_PRODUCT_LINE_LONG_DESCRIPTION,
    DIP.DIP_COVERAGE_PRODUCT_LINE_SHORT_DESCRIPTION,
    DIP.DIP_EMPLOYEE_ID,
    DIP.DIP_AGENT_NO,
    DIP.DIP_CANCEL_EFFECTIVE_DT,
    DIP.DIP_CANCEL_ACCOUNTING_DT,
    DIP.DIP_CANCEL_BIF_BRANCH_NO,
    DIP.DIP_CANCEL_SCORE_BRANCH_NO,
    DIP.DIP_CANCEL_CD,
    DIP.DIP_CANCEL_PREMIUM_AM,
    DIP.DIP_COVERAGE_LOAD_TS,
    DIP.DIP_CANCEL_LOAD_TS,
    DIP.DIP_RECORD_CREATED_TS,
    DIP.DIP_RECORD_UPDATE_TS,
    DIP.DIP_LOAN_ELIGIBLE,
    DIP.DIP_CPL_DT,
    DIP.DIP_INCENTIVE_EMPLOYEE_ID
FROM 
    bdm.app_loan_production A
    -- Join SCL
    LEFT JOIN view_SCL_flags SCL 
        ON A.uai_id = SCL.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(SCL.score_branch_no AS INT)
    -- Join SCA
    LEFT JOIN view_SCA_flags SCA 
        ON A.uai_id = SCA.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(SCA.score_branch_no AS INT)
    -- Join IUI
    LEFT JOIN view_IUI_flags IUI 
        ON A.uai_id = IUI.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(IUI.score_branch_no AS INT)
    -- Join GAP
    LEFT JOIN view_GAP_flags GAP 
        ON A.uai_id = GAP.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(GAP.score_branch_no AS INT)
    -- Join AUT
    LEFT JOIN view_AUT_flags AUT 
        ON A.uai_id = AUT.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(AUT.score_branch_no AS INT)
    -- Join HA
    LEFT JOIN view_HA_flags HA 
        ON A.uai_id = HA.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(HA.score_branch_no AS INT)
    -- Join ATL
    LEFT JOIN view_ATL_flags ATL 
        ON A.uai_id = ATL.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(ATL.score_branch_no AS INT)
    -- Join SSG
    LEFT JOIN view_SSG_flags SSG 
        ON A.uai_id = SSG.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(SSG.score_branch_no AS INT)
    -- Join DIP
    LEFT JOIN view_DIP_flags DIP 
        ON A.uai_id = DIP.uai_id AND CAST(A.own_score_brnch AS INT) = CAST(DIP.score_branch_no AS INT)
WHERE 
    A.CORE_V_CAPP = 'Core'
    AND A.APPL_STAT = 'BOOK'
    AND A.APPROVED_FLAG = 'Y'
    AND A.contr_date BETWEEN '2025-01-01' AND '2025-12-31';

-- ====================================================================
-- SUMMARY QUERIES
-- ====================================================================
SELECT 
    COUNT(*) AS total_booked_loans,
    -- SCL (Single Credit Life)
    SUM(IS_SCL_ELIGIBLE)   AS scl_eligible,
    SUM(IS_SCL_GROSS_SOLD) AS scl_sold_gross,
    SUM(IS_SCL_CANCELED)   AS scl_canceled,
    SUM(IS_SCL_NET_SOLD)   AS scl_sold_net,
    SUM(IS_SCL_CANCEL_WITHIN_30DAYS) AS scl_cancel_30d,
    SUM(IS_SCL_CANCEL_WITHIN_60DAYS) AS scl_cancel_60d,
    SUM(IS_SCL_CUSTOMER_INITIATED_CANCEL) AS scl_cancel_cust_init,

    -- SCA (Single Credit Accident)
    SUM(IS_SCA_ELIGIBLE)   AS sca_eligible,
    SUM(IS_SCA_GROSS_SOLD) AS sca_sold_gross,
    SUM(IS_SCA_CANCELED)   AS sca_canceled,
    SUM(IS_SCA_NET_SOLD)   AS sca_sold_net,
    SUM(IS_SCA_CANCEL_WITHIN_30DAYS) AS sca_cancel_30d,
    SUM(IS_SCA_CANCEL_WITHIN_60DAYS) AS sca_cancel_60d,
    SUM(IS_SCA_CUSTOMER_INITIATED_CANCEL) AS sca_cancel_cust_init,

    -- IUI (Involuntary Unemployment)
    SUM(IS_IUI_ELIGIBLE)   AS iui_eligible,
    SUM(IS_IUI_GROSS_SOLD) AS iui_sold_gross,
    SUM(IS_IUI_CANCELED)   AS iui_canceled,
    SUM(IS_IUI_NET_SOLD)   AS iui_sold_net,
    SUM(IS_IUI_CANCEL_WITHIN_30DAYS) AS iui_cancel_30d,
    SUM(IS_IUI_CANCEL_WITHIN_60DAYS) AS iui_cancel_60d,
    SUM(IS_IUI_CUSTOMER_INITIATED_CANCEL) AS iui_cancel_cust_init,

    -- GAP (Guaranteed Asset Protection)
    SUM(IS_GAP_ELIGIBLE)   AS gap_eligible,
    SUM(IS_GAP_GROSS_SOLD) AS gap_sold_gross,
    SUM(IS_GAP_CANCELED)   AS gap_canceled,
    SUM(IS_GAP_NET_SOLD)   AS gap_sold_net,
    SUM(IS_GAP_CANCEL_WITHIN_30DAYS) AS gap_cancel_30d,
    SUM(IS_GAP_CANCEL_WITHIN_60DAYS) AS gap_cancel_60d,
    SUM(IS_GAP_CUSTOMER_INITIATED_CANCEL) AS gap_cancel_cust_init,

    -- AUT (Auto / Vehicle Service Contract)
    SUM(IS_AUT_ELIGIBLE)   AS aut_eligible,
    SUM(IS_AUT_GROSS_SOLD) AS aut_sold_gross,
    SUM(IS_AUT_CANCELED)   AS aut_canceled,
    SUM(IS_AUT_NET_SOLD)   AS aut_sold_net,
    SUM(IS_AUT_CANCEL_WITHIN_30DAYS) AS aut_cancel_30d,
    SUM(IS_AUT_CANCEL_WITHIN_60DAYS) AS aut_cancel_60d,
    SUM(IS_AUT_CUSTOMER_INITIATED_CANCEL) AS aut_cancel_cust_init,

    -- HA (Hospital Accident)
    SUM(IS_HA_ELIGIBLE)   AS ha_eligible,
    SUM(IS_HA_GROSS_SOLD) AS ha_sold_gross,
    SUM(IS_HA_CANCELED)   AS ha_canceled,
    SUM(IS_HA_NET_SOLD)   AS ha_sold_net,
    SUM(IS_HA_CANCEL_WITHIN_30DAYS) AS ha_cancel_30d,
    SUM(IS_HA_CANCEL_WITHIN_60DAYS) AS ha_cancel_60d,
    SUM(IS_HA_CUSTOMER_INITIATED_CANCEL) AS ha_cancel_cust_init,

    -- ATL (Auto Term Life)
    SUM(IS_ATL_ELIGIBLE)   AS atl_eligible,
    SUM(IS_ATL_GROSS_SOLD) AS atl_sold_gross,
    SUM(IS_ATL_CANCELED)   AS atl_canceled,
    SUM(IS_ATL_NET_SOLD)   AS atl_sold_net,
    SUM(IS_ATL_CANCEL_WITHIN_30DAYS) AS atl_cancel_30d,
    SUM(IS_ATL_CANCEL_WITHIN_60DAYS) AS atl_cancel_60d,
    SUM(IS_ATL_CUSTOMER_INITIATED_CANCEL) AS atl_cancel_cust_init,

    -- SSG (Supplemental Security / Other)
    SUM(IS_SSG_ELIGIBLE)   AS ssg_eligible,
    SUM(IS_SSG_GROSS_SOLD) AS ssg_sold_gross,
    SUM(IS_SSG_CANCELED)   AS ssg_canceled,
    SUM(IS_SSG_NET_SOLD)   AS ssg_sold_net,
    SUM(IS_SSG_CANCEL_WITHIN_30DAYS) AS ssg_cancel_30d,
    SUM(IS_SSG_CANCEL_WITHIN_60DAYS) AS ssg_cancel_60d,
    SUM(IS_SSG_CUSTOMER_INITIATED_CANCEL) AS ssg_cancel_cust_init,

    -- DIP (Disability Income Plus)
    SUM(IS_DIP_ELIGIBLE)   AS dip_eligible,
    SUM(IS_DIP_GROSS_SOLD) AS dip_sold_gross,
    SUM(IS_DIP_CANCELED)   AS dip_canceled,
    SUM(IS_DIP_NET_SOLD)   AS dip_sold_net,
    SUM(IS_DIP_CANCEL_WITHIN_30DAYS) AS dip_cancel_30d,
    SUM(IS_DIP_CANCEL_WITHIN_60DAYS) AS dip_cancel_60d,
    SUM(IS_DIP_CUSTOMER_INITIATED_CANCEL) AS dip_cancel_cust_init
FROM 
    optional_product_master;

SELECT 'SCL' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_SCL_ELIGIBLE) AS Eligible, SUM(IS_SCL_GROSS_SOLD) AS Sold, SUM(IS_SCL_CANCELED) AS Canceled, SUM(IS_SCL_NET_SOLD) AS Net_Sold, SUM(IS_SCL_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_SCL_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_SCL_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'SCA' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_SCA_ELIGIBLE) AS Eligible, SUM(IS_SCA_GROSS_SOLD) AS Sold, SUM(IS_SCA_CANCELED) AS Canceled, SUM(IS_SCA_NET_SOLD) AS Net_Sold, SUM(IS_SCA_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_SCA_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_SCA_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'IUI' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_IUI_ELIGIBLE) AS Eligible, SUM(IS_IUI_GROSS_SOLD) AS Sold, SUM(IS_IUI_CANCELED) AS Canceled, SUM(IS_IUI_NET_SOLD) AS Net_Sold, SUM(IS_IUI_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_IUI_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_IUI_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'GAP' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_GAP_ELIGIBLE) AS Eligible, SUM(IS_GAP_GROSS_SOLD) AS Sold, SUM(IS_GAP_CANCELED) AS Canceled, SUM(IS_GAP_NET_SOLD) AS Net_Sold, SUM(IS_GAP_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_GAP_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_GAP_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'AUT' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_AUT_ELIGIBLE) AS Eligible, SUM(IS_AUT_GROSS_SOLD) AS Sold, SUM(IS_AUT_CANCELED) AS Canceled, SUM(IS_AUT_NET_SOLD) AS Net_Sold, SUM(IS_AUT_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_AUT_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_AUT_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'HA' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_HA_ELIGIBLE) AS Eligible, SUM(IS_HA_GROSS_SOLD) AS Sold, SUM(IS_HA_CANCELED) AS Canceled, SUM(IS_HA_NET_SOLD) AS Net_Sold, SUM(IS_HA_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_HA_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_HA_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'ATL' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_ATL_ELIGIBLE) AS Eligible, SUM(IS_ATL_GROSS_SOLD) AS Sold, SUM(IS_ATL_CANCELED) AS Canceled, SUM(IS_ATL_NET_SOLD) AS Net_Sold, SUM(IS_ATL_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_ATL_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_ATL_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'SSG' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_SSG_ELIGIBLE) AS Eligible, SUM(IS_SSG_GROSS_SOLD) AS Sold, SUM(IS_SSG_CANCELED) AS Canceled, SUM(IS_SSG_NET_SOLD) AS Net_Sold, SUM(IS_SSG_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_SSG_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_SSG_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master
UNION ALL
SELECT 'DIP' AS Product, COUNT(*) AS Total_Booked_Loans, SUM(IS_DIP_ELIGIBLE) AS Eligible, SUM(IS_DIP_GROSS_SOLD) AS Sold, SUM(IS_DIP_CANCELED) AS Canceled, SUM(IS_DIP_NET_SOLD) AS Net_Sold, SUM(IS_DIP_CANCEL_WITHIN_30DAYS) AS Cancel_30D, SUM(IS_DIP_CANCEL_WITHIN_60DAYS) AS Cancel_60D, SUM(IS_DIP_CUSTOMER_INITIATED_CANCEL) AS Cancel_Cust_Init FROM optional_product_master;
